<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 15px;
            min-height: 100vh;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
        }

        h1 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .input-section {
            margin-bottom: 15px;
        }

        .input-section label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 10px;
        }

        .input-wrapper {
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #ffffff;
            padding: 5px;
        }

        #noteInput {
            width: 100%;
            min-height: 80px;
            border: none;
            outline: none;
            font-size: 10px;
            font-family: Arial, sans-serif;
            resize: vertical;
            padding: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 9px;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .btn-add {
            background-color: #4CAF50;
            color: white;
        }

        .btn-add:hover {
            background-color: #45a049;
        }

        .btn-clear {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-clear:hover {
            background-color: #d0d0d0;
        }

        .search-section {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .search-section label {
            font-weight: bold;
            font-size: 10px;
        }

        .search-wrapper {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #ffffff;
            padding: 5px;
        }

        #searchInput {
            width: 100%;
            border: none;
            outline: none;
            font-size: 10px;
            padding: 5px;
        }

        .btn-clear-search {
            background-color: #ffcccc;
            color: #333;
            padding: 5px 10px;
            font-size: 9px;
        }

        .search-count {
            font-size: 9px;
            color: #666;
            margin-left: 10px;
        }

        .notes-section {
            margin-bottom: 15px;
        }

        .notes-list {
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            background-color: #ffffff;
            padding: 2px;
        }

        .note-item {
            padding: 5px;
            margin: 2px;
            border-radius: 4px;
            display: flex;
            align-items: flex-start;
            gap: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .note-item:nth-child(even) {
            background-color: #f8f9fa;
        }

        .note-item:hover {
            background-color: #f0f0f0;
        }

        .note-item.selected {
            background-color: #e3f2fd !important;
            border: 2px solid #2196F3;
        }

        .note-item.highlighted {
            background-color: #fff9c4 !important;
        }

        .note-checkbox {
            margin-top: 3px;
            cursor: pointer;
        }

        .note-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .note-text {
            font-size: 10px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .note-text.done {
            color: #666;
            text-decoration: line-through;
        }

        .note-date {
            font-size: 8px;
            color: #999;
            margin-top: 2px;
        }

        .subnotes {
            margin-left: 30px;
            margin-top: 5px;
        }

        .subnote-item {
            padding: 3px;
            margin: 1px 0;
            display: flex;
            align-items: flex-start;
            gap: 5px;
            cursor: pointer;
        }

        .subnote-item:hover {
            background-color: #f5f5f5;
        }

        .subnote-text {
            font-size: 9px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .subnote-text.done {
            color: #666;
            text-decoration: line-through;
        }

        .actions-section {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .actions-left, .actions-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background-color: #da190b;
        }

        .btn-delete-all {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-delete-all:hover {
            background-color: #d0d0d0;
        }

        .btn-uncheck {
            background-color: #ff9800;
            color: white;
        }

        .btn-uncheck:hover {
            background-color: #e68900;
        }

        .btn-rename, .btn-subnote {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-rename:hover, .btn-subnote:hover {
            background-color: #d0d0d0;
        }

        .status-bar {
            background-color: #e0e0e0;
            padding: 8px;
            font-size: 8px;
            color: #666;
            border-top: 1px solid #ccc;
            margin-top: 10px;
        }

        .context-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 5px 0;
            display: none;
            z-index: 1000;
        }

        .context-menu-item {
            padding: 8px 20px;
            cursor: pointer;
            font-size: 9px;
        }

        .context-menu-item:hover {
            background-color: #f0f0f0;
        }

        @media (max-width: 600px) {
            .actions-section {
                flex-direction: column;
            }

            .actions-left, .actions-right {
                width: 100%;
            }

            button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section">
            <label>–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞:</label>
            <div class="input-wrapper">
                <textarea id="noteInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..."></textarea>
            </div>
            <div class="button-group">
                <button class="btn-add" onclick="addNote()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn-clear" onclick="clearInput()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>
            </div>
        </div>

        <div class="search-section">
            <label>üîç –ü–æ–∏—Å–∫:</label>
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...">
            </div>
            <button class="btn-clear-search" onclick="clearSearch()">‚úñÔ∏è</button>
            <span class="search-count" id="searchCount"></span>
        </div>

        <div class="notes-section">
            <h1>–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏:</h1>
            <div class="notes-list" id="notesList"></div>
        </div>

        <div class="actions-section">
            <div class="actions-left">
                <button class="btn-delete" onclick="deleteSelected()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é</button>
                <button class="btn-delete" onclick="deleteCompleted()">‚úÖ –£–¥–∞–ª–∏—Ç—å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ</button>
                <button class="btn-delete-all" onclick="deleteAll()">üî• –£–¥–∞–ª–∏—Ç—å –≤—Å–µ</button>
                <button class="btn-uncheck" onclick="uncheckAll()">‚òê –°–Ω—è—Ç—å –≤—Å–µ –≥–∞–ª–æ—á–∫–∏</button>
            </div>
            <div class="actions-right">
                <button class="btn-subnote" onclick="addSubnote()">üìù –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–º–µ—Ç–∫—É</button>
                <button class="btn-rename" onclick="renameSelected()">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                <button class="btn-rename" onclick="exportData()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn-rename" onclick="document.getElementById('importFile').click()">üì• –ò–º–ø–æ—Ä—Ç</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>

        <div class="status-bar" id="statusBar">–í—Å–µ–≥–æ –∑–∞–º–µ—Ç–æ–∫: 0</div>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextMenuEdit()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="context-menu-item" onclick="contextMenuDelete()">–£–¥–∞–ª–∏—Ç—å</div>
    </div>

    <script>
        let notes = [];
        let filteredNotes = [];
        let selectedIndex = null;
        let searchText = '';
        let contextMenuData = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫ –∏–∑ localStorage
        function loadNotes() {
            const saved = localStorage.getItem('notes_data');
            if (saved) {
                try {
                    notes = JSON.parse(saved);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–º–µ—Ç–æ–∫:', e);
                    notes = [];
                }
            } else {
                notes = [];
            }
            filterNotes();
            renderNotes();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫ –≤ localStorage
        function saveNotes() {
            try {
                localStorage.setItem('notes_data', JSON.stringify(notes));
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫: ' + e.message);
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
        function getCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
        function addNote() {
            const input = document.getElementById('noteInput');
            const text = input.value.trim();
            if (!text) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏.');
                return;
            }
            notes.push({
                text: text,
                done: false,
                subnotes: [],
                created: getCurrentDateTime()
            });
            input.value = '';
            selectedIndex = notes.length - 1;
            filterNotes();
            renderNotes();
            saveNotes();
            input.focus();
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
        function clearInput() {
            document.getElementById('noteInput').value = '';
            document.getElementById('noteInput').focus();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–º–µ—Ç–∫–∏
        function toggleNote(index) {
            if (0 <= index && index < notes.length) {
                notes[index].done = !notes[index].done;
                renderNotes();
                saveNotes();
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∑–∞–º–µ—Ç–∫–∏
        function toggleSubnote(noteIndex, subIndex) {
            if (0 <= noteIndex && noteIndex < notes.length) {
                const subnotes = notes[noteIndex].subnotes || [];
                if (0 <= subIndex && subIndex < subnotes.length) {
                    subnotes[subIndex].done = !subnotes[subIndex].done;
                    renderNotes();
                    saveNotes();
                }
            }
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–º–µ—Ç–æ–∫
        function filterNotes() {
            if (!searchText) {
                filteredNotes = notes.map((_, i) => i);
                return;
            }
            const searchLower = searchText.toLowerCase();
            filteredNotes = [];
            for (let i = 0; i < notes.length; i++) {
                const note = notes[i];
                if (note.text.toLowerCase().includes(searchLower)) {
                    filteredNotes.push(i);
                    continue;
                }
                const subnotes = note.subnotes || [];
                for (const sub of subnotes) {
                    if (sub.text.toLowerCase().includes(searchLower)) {
                        filteredNotes.push(i);
                        break;
                    }
                }
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
        function onSearchChange() {
            searchText = document.getElementById('searchInput').value.trim();
            filterNotes();
            renderNotes();
        }

        // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchText = '';
            filterNotes();
            renderNotes();
            document.getElementById('noteInput').focus();
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–º–µ—Ç–∫—É
        function setSelected(index) {
            selectedIndex = index;
            renderNotes();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫
        function renderNotes() {
            const list = document.getElementById('notesList');
            list.innerHTML = '';

            // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
            const searchCountEl = document.getElementById('searchCount');
            if (searchText) {
                searchCountEl.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${filteredNotes.length} –∏–∑ ${notes.length}`;
            } else {
                searchCountEl.textContent = '';
            }

            if (filteredNotes.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 10px;">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';
                updateStatus();
                return;
            }

            filteredNotes.forEach((noteIndex, displayIndex) => {
                if (noteIndex < 0 || noteIndex >= notes.length) return;
                const note = notes[noteIndex];

                const noteItem = document.createElement('div');
                noteItem.className = 'note-item';
                if (selectedIndex === noteIndex) {
                    noteItem.classList.add('selected');
                }
                if (searchText && note.text.toLowerCase().includes(searchText.toLowerCase())) {
                    noteItem.classList.add('highlighted');
                }

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'note-checkbox';
                checkbox.checked = note.done || false;
                checkbox.onchange = () => toggleNote(noteIndex);

                const content = document.createElement('div');
                content.className = 'note-content';

                const text = document.createElement('div');
                text.className = 'note-text' + (note.done ? ' done' : '');
                text.textContent = note.text;
                text.ondblclick = () => renameNote(noteIndex);
                text.oncontextmenu = (e) => {
                    e.preventDefault();
                    showContextMenu(e, noteIndex, null);
                };

                content.appendChild(text);

                if (note.created) {
                    const date = document.createElement('div');
                    date.className = 'note-date';
                    date.textContent = note.created;
                    content.appendChild(date);
                }

                noteItem.appendChild(checkbox);
                noteItem.appendChild(content);
                noteItem.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        setSelected(noteIndex);
                    }
                };

                // –ü–æ–¥–∑–∞–º–µ—Ç–∫–∏
                if (note.subnotes && note.subnotes.length > 0) {
                    const subnotesDiv = document.createElement('div');
                    subnotesDiv.className = 'subnotes';
                    note.subnotes.forEach((sub, subIndex) => {
                        const subItem = document.createElement('div');
                        subItem.className = 'subnote-item';

                        const subCheckbox = document.createElement('input');
                        subCheckbox.type = 'checkbox';
                        subCheckbox.className = 'note-checkbox';
                        subCheckbox.checked = sub.done || false;
                        subCheckbox.onchange = () => toggleSubnote(noteIndex, subIndex);

                        const subText = document.createElement('div');
                        subText.className = 'subnote-text' + (sub.done ? ' done' : '');
                        subText.textContent = '‚Ä¢ ' + sub.text;
                        subText.ondblclick = () => renameSubnote(noteIndex, subIndex);
                        subText.oncontextmenu = (e) => {
                            e.preventDefault();
                            showContextMenu(e, noteIndex, subIndex);
                        };

                        subItem.appendChild(subCheckbox);
                        subItem.appendChild(subText);
                        subnotesDiv.appendChild(subItem);
                    });
                    content.appendChild(subnotesDiv);
                }

                list.appendChild(noteItem);
            });

            updateStatus();
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–∞—Ä
        function updateStatus() {
            const total = notes.length;
            const completed = notes.filter(n => n.done).length;
            let statusText = `–í—Å–µ–≥–æ –∑–∞–º–µ—Ç–æ–∫: ${total} | –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${completed}`;
            if (searchText) {
                statusText += ` | –ù–∞–π–¥–µ–Ω–æ: ${filteredNotes.length}`;
            }
            statusText += ' | Ctrl+F - –ø–æ–∏—Å–∫ | ‚Üë‚Üì - –Ω–∞–≤–∏–≥–∞—Ü–∏—è | Delete - —É–¥–∞–ª–∏—Ç—å | F2 - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
            document.getElementById('statusBar').textContent = statusText;
        }

        // –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–º–µ—Ç–∫—É
        function deleteSelected() {
            if (selectedIndex === null || selectedIndex < 0 || selectedIndex >= notes.length) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
                return;
            }
            const note = notes[selectedIndex];
            const noteText = note.text.length > 50 ? note.text.substring(0, 50) + '...' : note.text;
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?\n\n"${noteText}"`)) {
                notes.splice(selectedIndex, 1);
                selectedIndex = null;
                filterNotes();
                renderNotes();
                saveNotes();
            }
        }

        // –£–¥–∞–ª–∏—Ç—å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏
        function deleteCompleted() {
            const completed = notes.filter(n => n.done);
            if (completed.length === 0) {
                alert('–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫.');
                return;
            }
            if (confirm(`–£–¥–∞–ª–∏—Ç—å ${completed.length} –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫?`)) {
                notes = notes.filter(n => !n.done);
                selectedIndex = null;
                filterNotes();
                renderNotes();
                saveNotes();
            }
        }

        // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏
        function deleteAll() {
            if (notes.length === 0) {
                alert('–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
                return;
            }
            if (confirm(`–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ ${notes.length} –∑–∞–º–µ—Ç–æ–∫?`)) {
                notes = [];
                selectedIndex = null;
                filterNotes();
                renderNotes();
                saveNotes();
            }
        }

        // –°–Ω—è—Ç—å –≤—Å–µ –≥–∞–ª–æ—á–∫–∏
        function uncheckAll() {
            let checkedCount = 0;
            notes.forEach(note => {
                if (note.done) checkedCount++;
                note.subnotes?.forEach(sub => {
                    if (sub.done) checkedCount++;
                });
            });
            if (checkedCount === 0) {
                alert('–ù–µ—Ç –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫.');
                return;
            }
            if (confirm(`–°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫–∏ '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ' —Å–æ –≤—Å–µ—Ö ${checkedCount} –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫ –∏ –ø–æ–¥–∑–∞–º–µ—Ç–æ–∫?`)) {
                notes.forEach(note => {
                    note.done = false;
                    note.subnotes?.forEach(sub => {
                        sub.done = false;
                    });
                });
                renderNotes();
                saveNotes();
            }
        }

        // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–º–µ—Ç–∫—É
        function renameSelected() {
            if (selectedIndex === null || selectedIndex < 0 || selectedIndex >= notes.length) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è.');
                return;
            }
            renameNote(selectedIndex);
        }

        // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É
        function renameNote(index) {
            if (index < 0 || index >= notes.length) return;
            const current = notes[index].text;
            const newText = prompt('–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏:', current);
            if (newText !== null && newText.trim()) {
                notes[index].text = newText.trim();
                notes[index].modified = getCurrentDateTime();
                renderNotes();
                saveNotes();
            }
        }

        // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–º–µ—Ç–∫—É
        function addSubnote() {
            if (selectedIndex === null || selectedIndex < 0 || selectedIndex >= notes.length) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–º–µ—Ç–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–∑–∞–º–µ—Ç–∫–∏.');
                return;
            }
            const text = prompt('–¢–µ–∫—Å—Ç –ø–æ–¥–∑–∞–º–µ—Ç–∫–∏:');
            if (text !== null && text.trim()) {
                if (!notes[selectedIndex].subnotes) {
                    notes[selectedIndex].subnotes = [];
                }
                notes[selectedIndex].subnotes.push({
                    text: text.trim(),
                    done: false
                });
                renderNotes();
                saveNotes();
            }
        }

        // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–æ–¥–∑–∞–º–µ—Ç–∫—É
        function renameSubnote(noteIndex, subIndex) {
            if (noteIndex < 0 || noteIndex >= notes.length) return;
            const subnotes = notes[noteIndex].subnotes || [];
            if (subIndex < 0 || subIndex >= subnotes.length) return;
            const current = subnotes[subIndex].text;
            const newText = prompt('–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø–æ–¥–∑–∞–º–µ—Ç–∫–∏:', current);
            if (newText !== null && newText.trim()) {
                subnotes[subIndex].text = newText.trim();
                renderNotes();
                saveNotes();
            }
        }

        // –£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–º–µ—Ç–∫—É
        function deleteSubnote(noteIndex, subIndex) {
            if (noteIndex < 0 || noteIndex >= notes.length) return;
            const subnotes = notes[noteIndex].subnotes || [];
            if (subIndex < 0 || subIndex >= subnotes.length) return;
            const subText = subnotes[subIndex].text;
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–º–µ—Ç–∫—É?\n\n"${subText}"`)) {
                subnotes.splice(subIndex, 1);
                renderNotes();
                saveNotes();
            }
        }

        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        function showContextMenu(e, noteIndex, subIndex) {
            const menu = document.getElementById('contextMenu');
            contextMenuData = { noteIndex, subIndex };
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function contextMenuEdit() {
            if (contextMenuData) {
                const { noteIndex, subIndex } = contextMenuData;
                if (subIndex !== null) {
                    renameSubnote(noteIndex, subIndex);
                } else {
                    renameNote(noteIndex);
                }
            }
            hideContextMenu();
        }

        function contextMenuDelete() {
            if (contextMenuData) {
                const { noteIndex, subIndex } = contextMenuData;
                if (subIndex !== null) {
                    deleteSubnote(noteIndex, subIndex);
                } else {
                    if (confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?\n\n"${notes[noteIndex].text.substring(0, 50)}${notes[noteIndex].text.length > 50 ? '...' : ''}"`)) {
                        notes.splice(noteIndex, 1);
                        selectedIndex = null;
                        filterNotes();
                        renderNotes();
                        saveNotes();
                    }
                }
            }
            hideContextMenu();
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            contextMenuData = null;
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∑–∞–º–µ—Ç–∫–∞–º
        function navigateNotes(direction) {
            if (filteredNotes.length === 0) return;
            let currentPos = 0;
            if (selectedIndex !== null) {
                currentPos = filteredNotes.indexOf(selectedIndex);
                if (currentPos === -1) {
                    currentPos = direction > 0 ? 0 : filteredNotes.length - 1;
                } else {
                    currentPos += direction;
                    currentPos = Math.max(0, Math.min(filteredNotes.length - 1, currentPos));
                }
            } else {
                currentPos = direction > 0 ? 0 : filteredNotes.length - 1;
            }
            if (0 <= currentPos && currentPos < filteredNotes.length) {
                selectedIndex = filteredNotes[currentPos];
                renderNotes();
                // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–º–µ—Ç–∫–µ
                const selectedEl = document.querySelector('.note-item.selected');
                if (selectedEl) {
                    selectedEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            // Ctrl+Enter - –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                addNote();
            }
            // Escape - –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏–ª–∏ —Å–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (e.key === 'Escape') {
                if (document.activeElement === document.getElementById('noteInput')) {
                    clearInput();
                } else if (document.activeElement === document.getElementById('searchInput')) {
                    clearSearch();
                } else {
                    selectedIndex = null;
                    renderNotes();
                }
            }
            // Delete - —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–º–µ—Ç–∫—É
            if (e.key === 'Delete' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                deleteSelected();
            }
            // F2 - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
            if (e.key === 'F2' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                renameSelected();
            }
            // –°—Ç—Ä–µ–ª–∫–∏ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ - –Ω–∞–≤–∏–≥–∞—Ü–∏—è
            if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                e.preventDefault();
                navigateNotes(e.key === 'ArrowUp' ? -1 : 1);
            }
            // Ctrl+F - —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–∏—Å–∫
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            // Ctrl+N - —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                document.getElementById('noteInput').focus();
            }
        });

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function exportData() {
            const dataStr = JSON.stringify(notes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'notes_data.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        if (confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${imported.length} –∑–∞–º–µ—Ç–æ–∫? –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–º–µ—Ç–∫–∏ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.`)) {
                            notes = imported;
                            selectedIndex = null;
                            filterNotes();
                            renderNotes();
                            saveNotes();
                            alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
                        }
                    } else {
                        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤ –∑–∞–º–µ—Ç–æ–∫.');
                    }
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // –°–±—Ä–æ—Å input –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
        }

        // –ó–∞–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu') && !e.target.closest('.note-text') && !e.target.closest('.subnote-text')) {
                hideContextMenu();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.getElementById('searchInput').addEventListener('input', onSearchChange);
        document.getElementById('noteInput').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                e.target.select();
            }
        });

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–º–µ—Ç–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadNotes();
    </script>
</body>
</html>
